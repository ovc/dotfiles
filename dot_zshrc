#  Мгновенная отрисовка интерфейса (должна быть первой!) 
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Менеджер плагинов Zinit
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
source "${ZINIT_HOME}/zinit.zsh"

# Тема Powerlevel10k (мгновенная загрузка) 
zinit ice depth"1" 
zinit light romkatv/powerlevel10k
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# Фоновая загрузка тяжелых плагинов (lucid wait'0') 
zinit ice lucid wait'0'
zinit snippet OMZ::plugins/sudo

zinit ice lucid wait'0'
zinit snippet OMZ::plugins/git

# Vi-mode конфигурация
function zvm_config() {
  ZVM_VI_INSERT_ESCAPE_BINDKEY=jk
  ZVM_LINE_INIT_MODE=$ZVM_MODE_INSERT
  ZVM_KEYTIMEOUT=0.05
}
zinit ice depth=1
zinit light jeffreytse/zsh-vi-mode

# Загрузка плагина zsh-syntax-highlighting
#
zinit ice lucid wait'2'
zinit light zsh-users/zsh-syntax-highlighting

zinit ice lucid wait'2'
zinit light zsh-users/zsh-autosuggestions

zinit ice lucid wait'0' atload="_history_substring_search_config"
zinit light zsh-users/zsh-history-substring-search

# Функция настройки (выполнится автоматически после загрузки)
function _history_substring_search_config() {
  # Привязка стрелок вверх/вниз
  bindkey "$terminfo[kcuu1]" history-substring-search-up
  bindkey "$terminfo[kcud1]" history-substring-search-down
  
  # Привязка для режима Vi (если используете)
  # bindkey -M vicmd 'k' history-substring-search-up
  # bindkey -M vicmd 'j' history-substring-search-down

  bindkey '^P' history-substring-search-up
  bindkey '^N' history-substring-search-down

  # Настройка цветов (необязательно)
  HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_FOUND='fg=magenta,bold'
  HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_NOT_FOUND='fg=red,bold'
}

# PATH и NIX Перенесено в .zprofile

# Настройки истории (Оптимизировано для скорости)
HISTFILE="$HOME/.zsh_history"
HISTSIZE=1000000
SAVEHIST=1000000

# Запись и синхронизация
setopt SHARE_HISTORY          # Импорт/экспорт истории в реальном времени
setopt HIST_IGNORE_SPACE      # Игнорировать команды с пробелом в начале (для паролей)
setopt HIST_REDUCE_BLANKS     # Убирать лишние пробелы в командах
export HISTIGNORE="pwd:ls:cd" # Remove history data we don't want to see 

# Умная работа с дубликатами
setopt HIST_IGNORE_ALL_DUPS   # Удалять старые дубли при записи новых
setopt HIST_SAVE_NO_DUPS      # Не писать дубликаты в файл
setopt HIST_FIND_NO_DUPS      # Не показывать дубли при поиске
setopt HIST_EXPIRE_DUPS_FIRST # Если место кончится, сначала удалять дубли

# Безопасность и удобство
setopt EXTENDED_HISTORY       # Хранить время выполнения и длительность
setopt HIST_VERIFY            # Дать шанс проверить команду после расширения (напр. !!)
setopt NO_HIST_BEEP           # Отключить бесячий писк при ошибках в истории

# Дополнительно (опционально)
unsetopt BANG_HIST            # Если вы НЕ используете '!' для вызова команд,
                              # лучше выключить, чтобы не экранировать каждый раз 'sudo apt install !!'

# Алиасы
alias update-tools='arkade get kubectl helm terraform jq k9s yq krew'
command -v xset >/dev/null && xset r rate 200 100

# Автозапуск TMUX (Финальный блок) 
# Используем -A для мгновенного подключения к сессии 'main'
if [[ -z "$TMUX" && -z "$VSCODE_PID" && -z "$SSH_TTY" && $- == *i* ]]; then
    exec tmux new-session -A -s main
fi
